{% extends 'prelogin/base.html' %}
{% load i18n %}
{% load hq_shared_tags %}

{% block stylesheets %}
    <link href="{% static "app_manager/js/vellum/style.css" %}" type="text/css" rel="stylesheet"/>
    <style>
        .form-signup {
            margin-left: 0;
        }
    </style>
{% endblock stylesheets %}

{% block js-inline %}
    <script>
        $(function(){
            var signUpFormHandler = function() {
                var submittedForm = $(this);
                kmqPushSafe(['record', 'Clicked "Sign up" from demo', {}, function() {
                    submittedForm.off('submit', signUpFormHandler).submit();
                }]);
                return false;
            };
            $('form.form-signup').on('submit', signUpFormHandler);
        });
    </script>
    <script>
        // TODO: share with form_designer.html?
        var CKEDITOR_BASEPATH = "{% static "app_manager/js/vellum/lib/ckeditor/" %}";

        define("jquery", [], function () { return window.jQuery; });
        define("jquery.bootstrap", ["jquery"], function () {});
        define("underscore", [], function () { return window._; });

        require.config({
            baseUrl: "{% static "app_manager/js/vellum/src" %}",
            // handle very bad connections
            waitSeconds: 60,
            urlArgs: 'version={% cachebuster "app_manager/js/vellum/src/main-components.js" %}{% cachebuster "app_manager/js/vellum/src/local-deps.js" %}',
            paths: {
                'jquery.vellum': 'main'
            }
        });

        require(["options", "jquery", "jquery.vellum"], function (options, $) {
            $(function () {
                var VELLUM_OPTIONS = options.options;
                VELLUM_OPTIONS.plugins = ["modeliteration", "itemset", "atwho"];
                VELLUM_OPTIONS.core.saveType = 'full';
                VELLUM_OPTIONS.core.saveUrl = function(data) {
                    $("#signupModal").modal();
                };
                VELLUM_OPTIONS.windowManager = {
                    leftOffset: 0,
                    topOffset: 0,
                };
                $('#formdesigner').vellum(VELLUM_OPTIONS);

                $(".fd-ui-container").css("margin-top", $("nav.navbar-static-hq").outerHeight());
                $(".fd-fullscreen-button").addClass("hide");

                // Clicking "save" causes the button to change to "saved". If user
                // cancels out of the modal, force it back to green "save" state.
                $("#signupModal").on('hide.bs.modal', function() {
                    $('#formdesigner').vellum("get").data.core.saveButton.fire("change");
                });
            });
        });

    </script>
{% endblock %}

{% block content %}
    <div id="formdesigner" class="clearfix"></div>
{% endblock %}

{% block modals %}
    <div id="signupModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Close' %}</span></button>
                    <h3 class="modal-title">
                        {% trans "Account Needed" %}
                    </h3>
                </div>
                <div class="modal-body">
                    {% blocktrans %}
                        <p>To save this form, you'll need a CommCare account.</p>
                        <p>Once that's done, we'll create an application for you with this form.
                        You can add other forms and set up more complex workflows, or just deploy to a mobile
                        device and go!</p>
                    {% endblocktrans %}
                    {% include 'prelogin/partials/signup_form.html' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
