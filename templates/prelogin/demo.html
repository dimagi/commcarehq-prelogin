{% extends 'prelogin/base.html' %}
{% load i18n %}
{% load hq_shared_tags %}

{% block stylesheets %}
    <link href="{% static "app_manager/js/vellum/style.css" %}" type="text/css" rel="stylesheet"/>
    <style>
        .form-signup {
            margin-left: 0;
        }
    </style>
{% endblock stylesheets %}

{% block js-inline %}
    <script>
        var CKEDITOR_BASEPATH = "{% static "app_manager/js/vellum/lib/ckeditor/" %}";

        var dataSources = [
            {
                id: "commcaresession",
                uri: "jr://instance/session",
                path: "/session/data",
                name: 'Session',
                structure: {
                    "case_id": {
                        reference: {
                            source: "casedb",
                            subset: "case",
                            key: "@case_id",
                        },
                    },
                },
            }, {
                id: "casedb",
                uri: "jr://instance/casedb",
                path: "/cases/case",
                name: 'Cases',
                structure: {
                    name: {},
                },
                subsets: [{
                    id: "grandparent",
                    name: "grandparent (household)",
                    key: "@case_type",
                    structure: {
                        address: {},
                    }
                }, {
                    id: "parent",
                    name: "parent (mother)",
                    key: "@case_type",
                    structure: {
                        edd: {},
                    },
                    related: {
                        parent: "grandparent",
                    }
                }, {
                    id: "case",
                    name: "case (child)",
                    key: "@case_type",
                    structure: {
                        dob: {},
                        height: {},
                        weight: {},
                    },
                    related: {
                        parent: "parent",
                    },
                }]
            }, {
                id: "some-fixture",
                uri: "jr://fixture/item-list:some-fixture",
                path: "/some-fixture_list/some-fixture",
                name: 'some-fixture-name',
                structure: {
                    "inner-attribute": {
                        structure: {
                            "extra-inner-attribute": {}
                        }
                    },
                    "@id": {
                        no_option: true
                    },
                    name: {
                        no_option: true
                    }
                }
            },
        ];

        var VELLUM_OPTIONS = {
            plugins: ["modeliteration", "itemset", "atwho", "commtrack", "databrowser"],
            features: {
                'lookup_tables': true,
                'group_in_field_list': true,
                'rich_text': true,
                'advanced_itemsets': true,
                'printing': true,
                'templated_intents': true,
                'custom_intents': true,
                'image_resize': true,
                'markdown_in_groups': true,
                'allow_data_reference_in_setvalue': true,
            },
            core: {
                loadDelay: 0,
                formName: "Untitled Form",
                allowedDataNodeReferences: [
                    "meta/deviceID",
                    "meta/instanceID",
                    "meta/username",
                    "meta/userID",
                    "meta/timeStart",
                    "meta/timeEnd",
                    "meta/location",
                ],
                dataSourcesEndpoint: function (callback) { callback(dataSources); },
                invalidCaseProperties: ['name'],
                saveUrl: function (data) {
                    $("#signupModal").modal();
                },
                activityUrl: null,               // may be function or URL string
                activityTimeout: 5 * 60 * 1000,  // 5 minutes in milliseconds
                externalLinks: {
                    changeSubscription: "#",
                },
            },
            intents: {
                templates: [
                    {
                        icon: "fa fa-map-marker",
                        name: "Area Mapper",
                        id: "com.richard.lu.areamapper",
                        extra: {ext: "value"},
                        response: {
                            r1: "x",
                            r2: "y",
                            r3: "z",
                            r4: "",
                        },
                    },
                    {
                        icon: "fa fa-barcode",
                        name: "Barcode Scanner",
                        id: "com.google.zxing.client.android.SCAN",
                        extra: {},
                        response: {},
                    },
                    {
                        icon: "icon-vellum-android-intent",
                        name: "Breath Counter",
                        id: "org.commcare.respiratory.BREATHCOUNT",
                    },
                    {
                        icon: "icon-vellum-android-intent",
                        name: "Fingerprint Scanner",
                        id: "com.simprints.id.REGISTER",
                        mime: "text/plain",
                    },
                ],
            },
            itemset: {
                dataSourcesFilter: function (sources) {
                    return _.filter(sources, function (source) {
                        return !source.uri || /^jr:\/\/fixture\//.test(source.uri);
                    });
                }
            },
            javaRosa: {
                langs: ['en', 'hin'],
                displayLanguage: 'en',
            },
            uploader: {
                uploadUrls: {
                    image: 'foo',
                    audio: 'foo',
                    video: 'foo',
                    text: 'foo',
                },
                objectMap: {},
            },
            windowManager: {
                leftOffset: 0,
                topOffset: function () {
                    return $("nav.navbar-static-hq").outerHeight();
                }
            },
        };

        define("jquery", [], function () { return window.jQuery; });
        define("jquery.bootstrap", ["jquery"], function () {});
        define("underscore", [], function () { return window._; });

        require.config({
            baseUrl: "{% static "app_manager/js/vellum/src" %}",
            // handle very bad connections
            waitSeconds: 60,
            urlArgs: 'version={% cachebuster "app_manager/js/vellum/src/main-components.js" %}{% cachebuster "app_manager/js/vellum/src/local-deps.js" %}',
            paths: {
                'jquery.vellum': 'main'
            }
        });

        require(["jquery", "jquery.vellum"], function ($) {
            $(function () {
                $('#formdesigner').vellum(VELLUM_OPTIONS);
                $(".fd-ui-container").css("margin-top", "60px");
                $(".fd-fullscreen-button").addClass("hide");

                var $accessoryScreen = $("<div></div>");
                $accessoryScreen.css("position", "absolute")
                               .css("top", 0)
                               .css("left", 0)
                               .css("right", 0)
                               .css("bottom", 0)
                               .css("background-color", "black")
                               .css("opacity", 0.4);
                var $accessoryTease = $("<div></div>");
                $accessoryTease.css("position", "absolute")
                               .css("top", "20px")
                               .css("left", "10%")
                               .css("width", "80%")
                               .css("border-radius", "4px")
                               .css("background-color", "white")
                               .css("padding", "10px")
                               .css("opacity", 1)
                               .addClass("hide")
                               .html("You should try CommCare for real to create multiple forms and share data between them. Complex workflows are great. <a href='https://confluence.dimagi.com/display/commcarepublic/Case+Management'>Learn more about how great they are.</a>");
                var $accessoryPane = $(".fd-accessory-pane");
                $accessoryPane.css("position", "relative");
                $accessoryPane.append($accessoryScreen);
                $accessoryPane.append($accessoryTease);
                $accessoryPane.hover(function() {
                    $accessoryTease.removeClass("hide");
                }, function() {
                    $accessoryTease.addClass("hide");
                });
            });
        });

    </script>
{% endblock %}

{% block content %}
    <div id="formdesigner" class="clearfix"></div>
{% endblock %}

{% block modals %}
    <div id="signupModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Close' %}</span></button>
                    <h3 class="modal-title">
                        Account Needed
                    </h3>
                </div>
                <div class="modal-body">
                    {% blocktrans %}
                        <p>To save this form, you'll need a CommCare account.</p>
                        <p>Once that's done, we'll create an application for you with this form.
                        You can add other forms and set up more complex workflows, or just deploy to a mobile
                        device and go!</p>
                    {% endblocktrans %}
                    <form class="form-signup" role="form" method="get" action="{% url 'register_user' %}">
                          <label class="sr-only"
                                 for="signUpEmail">{% trans "Email" %}</label>
                          <div class="row">
                            <div class="col-xs-6 col-sm-7 col-lg-8">
                              <input type="text"
                                     class="form-control input-xl"
                                     name="e"
                                     id="signUpEmail"
                                     placeholder="{% trans 'enter your email' %}" />
                            </div>
                            <div class="col-xs-6 col-sm-5 col-lg-4">
                              <button type="submit"
                                  class="btn btn-success btn-xl btn-full-width">
                                {% trans "Sign Up for Free" %}
                              </button>
                            </div>
                          </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
